<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veus de Ciutat - Valencia (v8.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap');
        
        body { font-family: 'Montserrat', sans-serif; background-color: #f5f3ff; /* Fondo Lavanda muy suave */ }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-section { display: none; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        /* NUEVO DEGRADADO ÍNDIGO (A juego con el logo) */
        .hero-bg { background: linear-gradient(135deg, #e0e7ff 0%, #a5b4fc 100%); color: #1e1b4b; }
        
        .nav-btn { background-color: rgba(255, 255, 255, 0.5); color: #1e1b4b; }
        .nav-btn:hover { background-color: rgba(255, 255, 255, 0.8); }

        .loader {
            border: 4px solid #e0e7ff; border-top: 4px solid #6366f1; /* Índigo vivo */
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .audio-wave { display: flex; align-items: center; justify-content: center; height: 20px; gap: 3px; }
        .audio-bar { width: 4px; background: #6366f1; animation: audio-wave 1s ease-in-out infinite; } /* Índigo */
        .audio-bar:nth-child(2) { animation-delay: 0.1s; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; }
        .audio-bar:nth-child(5) { animation-delay: 0.4s; }
        @keyframes audio-wave { 0%, 100% { height: 5px; } 50% { height: 20px; } }
        
        .prose h3 { color: #4338ca; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em; font-size: 1.25rem; }
        .prose p { margin-bottom: 1em; line-height: 1.6; color: #374151; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; color: #374151; }
        .prose strong { color: #1e1b4b; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- CABECERA CON NUEVO DEGRADADO -->
    <header class="hero-bg p-4 md:p-6 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <!-- GRUPO LOGO + TÍTULO -->
            <div class="flex items-center gap-4 cursor-pointer" onclick="navigate('home')">
                <img src="logo-header.png" 
                     alt="Logo" 
                     class="h-20 w-auto object-contain drop-shadow-sm mix-blend-multiply" 
                     onerror="this.style.display='none'">
                
                <h1 class="text-xl md:text-3xl font-bold tracking-wider leading-tight text-indigo-950">
                    VEUS DE<br><span class="text-indigo-700">CIUTAT</span>
                </h1>
            </div>

            <!-- BOTÓN INICIO -->
            <nav>
                <button onclick="navigate('home')" class="text-sm font-bold transition nav-btn px-4 py-2 rounded-full shadow-sm hover:scale-105 active:scale-95">
                    INICIO
                </button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow relative">

        <!-- HOME -->
        <section id="home" class="fade-in flex flex-col items-center justify-center min-h-[60vh] gap-8">
            <div class="text-center mb-8 mt-4">
                <h2 class="text-4xl font-extrabold text-slate-800 mb-2">Descubre Valencia</h2>
                <p class="text-slate-500">Escucha, mira y siente la historia de la ciudad.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                <!-- Botones actualizados a tonos Índigo -->
                <button onclick="navigate('pois')" class="group relative overflow-hidden rounded-2xl h-48 shadow-lg transition-all hover:scale-105 border-4 border-white">
                    <div class="absolute inset-0 bg-indigo-400 opacity-90 group-hover:bg-indigo-500 transition"></div>
                    <img src="img/torres.jpg" class="absolute inset-0 w-full h-full object-cover mix-blend-overlay opacity-50" alt="Valencia" onerror="this.src='https://placehold.co/600x400?text=Valencia'">
                    <div class="relative z-10 flex flex-col items-center justify-center h-full text-white">
                        <i data-lucide="map-pin" class="w-10 h-10 mb-2"></i>
                        <span class="text-2xl font-bold">Puntos de Interés</span>
                    </div>
                </button>

                <button onclick="navigate('about')" class="group relative overflow-hidden rounded-2xl h-48 shadow-lg transition-all hover:scale-105 border-4 border-white">
                    <div class="absolute inset-0 bg-slate-600 opacity-90 group-hover:bg-slate-700 transition"></div>
                    <div class="relative z-10 flex flex-col items-center justify-center h-full text-white">
                        <i data-lucide="users" class="w-10 h-10 mb-2"></i>
                        <span class="text-2xl font-bold">Sobre Nosotros</span>
                    </div>
                </button>
            </div>
        </section>

        <!-- ABOUT -->
        <section id="about" class="hidden-section fade-in max-w-2xl mx-auto mt-8">
            <button onclick="navigate('home')" class="mb-6 flex items-center text-slate-500 hover:text-indigo-600 transition"><i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i> Volver al inicio</button>
            <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-indigo-400">
                <h2 class="text-3xl font-bold mb-4 text-slate-800">Sobre Veus de Ciutat</h2>
                <p class="text-slate-600 mb-4 leading-relaxed">"Veus de Ciutat" es una iniciativa cultural nacida para dar voz a las piedras, monumentos y rincones de Valencia.</p>
                <p class="text-slate-600 leading-relaxed">Ahora, gracias a la integración con la <strong>IA de Google Gemini</strong>, podemos ofrecerte guías personalizadas y narraciones de voz generadas al instante.</p>
            </div>
        </section>

        <!-- LISTA DE SITIOS -->
        <section id="pois" class="hidden-section fade-in">
            <div class="flex items-center mb-6">
                <button onclick="navigate('home')" class="mr-4 p-2 bg-slate-200 rounded-full hover:bg-slate-300 transition"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                <h2 class="text-2xl font-bold text-slate-800">Selecciona un lugar</h2>
            </div>
            <div id="places-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- DETALLE -->
        <section id="detail" class="hidden-section fade-in pb-10">
            <button onclick="navigate('pois')" class="mb-4 flex items-center text-white bg-slate-800/50 absolute top-4 left-4 p-2 rounded-full backdrop-blur z-20 hover:bg-slate-800"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <div class="relative h-64 md:h-80 rounded-b-3xl overflow-hidden -mx-4 -mt-4 mb-6 shadow-xl">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent z-10"></div>
                <img id="detail-image" src="" alt="Detalle" class="w-full h-full object-cover">
                <div class="absolute bottom-6 left-6 z-20 text-white">
                    <h2 id="detail-title" class="text-3xl md:text-4xl font-bold">Nombre del sitio</h2>
                    <p class="text-slate-200 text-sm mt-1">Valencia, España</p>
                </div>
            </div>

            <div class="max-w-3xl mx-auto px-2">
                <p class="text-center text-slate-500 mb-6">Selecciona el tipo de contenido que deseas explorar:</p>
                <div class="grid grid-cols-2 gap-4">
                    <!-- Botones actualizados a la gama Índigo/Morado -->
                    <div onclick="showMedia('audio')" class="cursor-pointer bg-white p-6 rounded-xl shadow-md border border-slate-100 hover:border-indigo-400 hover:bg-indigo-50 transition flex flex-col items-center gap-3">
                        <div class="bg-indigo-100 p-3 rounded-full text-indigo-600"><i data-lucide="headphones" class="w-6 h-6"></i></div>
                        <span class="font-bold text-slate-700">Audios IA</span>
                    </div>
                    <div onclick="showMedia('text')" class="cursor-pointer bg-white p-6 rounded-xl shadow-md border border-slate-100 hover:border-purple-400 hover:bg-purple-50 transition flex flex-col items-center gap-3">
                        <div class="bg-purple-100 p-3 rounded-full text-purple-600"><i data-lucide="file-text" class="w-6 h-6"></i></div>
                        <span class="font-bold text-slate-700">Guía IA</span>
                    </div>
                    <div onclick="showMedia('video')" class="cursor-pointer bg-white p-6 rounded-xl shadow-md border border-slate-100 hover:border-blue-400 hover:bg-blue-50 transition flex flex-col items-center gap-3">
                        <div class="bg-blue-100 p-3 rounded-full text-blue-600"><i data-lucide="video" class="w-6 h-6"></i></div>
                        <span class="font-bold text-slate-700">Vídeos</span>
                    </div>
                    <div onclick="showMedia('gallery')" class="cursor-pointer bg-white p-6 rounded-xl shadow-md border border-slate-100 hover:border-emerald-400 hover:bg-emerald-50 transition flex flex-col items-center gap-3">
                        <div class="bg-emerald-100 p-3 rounded-full text-emerald-600"><i data-lucide="image" class="w-6 h-6"></i></div>
                        <span class="font-bold text-slate-700">Imágenes</span>
                    </div>
                </div>

                <div id="media-display-area" class="mt-8 p-6 bg-white rounded-xl shadow-inner border border-slate-200 hidden min-h-[150px]">
                    <h3 id="media-title" class="text-xl font-bold mb-4 border-b pb-2 flex justify-between items-center text-indigo-900">
                        <span>Contenido</span>
                        <span id="status-badge" class="text-xs font-normal px-2 py-1 bg-gray-100 rounded-full text-gray-500 hidden"></span>
                    </h3>
                    <div id="media-content" class="text-slate-600 prose"></div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-slate-900 text-slate-400 py-6 mt-auto text-center text-sm"><p>&copy; 2024 Veus de Ciutat (v8.0)</p></footer>

    <script>
        const rawKey = "AIzaSyB8Nvs8yLBY2PJHrJtWCf6uSRdCqUbc2Co";
        const apiKey = rawKey.trim();

        lucide.createIcons();

        const placesData = [
            { id: 'torres', title: 'Torres de Serranos', image: 'img/torres.jpg', desc: 'Antigua puerta de la muralla medieval.' },
            { id: 'oceanografic', title: 'L\'Oceanogràfic', image: 'img/oceanografic.jpg', desc: 'El mayor acuario de Europa.' },
            { id: 'mercado', title: 'Mercado Central', image: 'img/mercado.jpg', desc: 'Joya del modernismo valenciano.' },
            { id: 'lonja', title: 'La Lonja de la Seda', image: 'img/lonja.jpg', desc: 'Patrimonio de la Humanidad.' },
            { id: 'catedral', title: 'La Catedral y el Miguelete', image: 'img/catedral.jpg', desc: 'Hogar del Santo Cáliz.' },
            { id: 'albufera', title: 'Parque Natural de la Albufera', image: 'img/albufera.jpg', desc: 'Naturaleza y origen de la paella.' }
        ];

        const backupContent = {
            'torres': {
                audio: "¡Bienvenido a las Torres de Serranos! ¿Sabías que estas piedras han visto pasar reyes, presos y hasta obras de arte? Construidas en el siglo XIV por Pere Balaguer, fueron la entrada principal de Valencia. Pero guardan un secreto: durante la Guerra Civil, aquí se escondieron los cuadros más famosos del Museo del Prado, cubiertos de hormigón para salvarlos de las bombas. Hoy, tú puedes subir a lo más alto y disfrutar de la mejor vista de la ciudad.",
                text: `<h3>Un gigante de piedra gótico</h3><p>Las <strong>Torres de Serranos</strong> son uno de los monumentos mejor conservados de Valencia. Construidas entre <strong>1392 y 1398</strong> por el maestro Pere Balaguer, se inspiraron en otras puertas góticas de la época, como las de Génova.</p><h3>De Entrada Real a Prisión</h3><p>Originalmente, eran la entrada principal para los reyes y embajadores que venían del norte. Sin embargo, su historia tiene un lado oscuro: desde finales del siglo XVI hasta 1887, se utilizaron como <strong>prisión para nobles</strong>.</p><h3>El secreto de la Guerra Civil</h3><p>Durante la Guerra Civil Española, las obras maestras del <strong>Museo del Prado</strong> (incluyendo Las Meninas de Velázquez) fueron evacuadas de Madrid y escondidas aquí. Se construyó una bóveda de hormigón armado dentro de las torres para protegerlas de los bombardeos.</p>`
            },
            'oceanografic': {
                audio: "Estás frente al Oceanogràfic, el acuario más grande de toda Europa. No es solo un edificio bonito diseñado por Félix Candela, es una ciudad submarina completa. Aquí abajo viven 45.000 animales de 500 especies diferentes. Tienes desde belugas del Ártico hasta tiburones que nadarán justo por encima de tu cabeza en el túnel submarino. Es un homenaje a los mares y océanos de nuestro planeta.",
                text: `<h3>Una ciudad bajo el mar</h3><p>El <strong>Oceanogràfic</strong> es la joya de la Ciudad de las Artes y las Ciencias. Inaugurado en 2003, sus espectaculares edificios con forma de nenúfar fueron diseñados por el arquitecto <strong>Félix Candela</strong>.</p><h3>Ecosistemas del mundo</h3><p>No es un simple acuario, es un recorrido por los principales mares del planeta. Con más de <strong>42 millones de litros de agua</strong>, puedes visitar el Ártico, el Mar Rojo y el Túnel Submarino.</p>`
            },
            'mercado': {
                audio: "Bienvenido a la Catedral de los Sentidos. El Mercado Central de Valencia no es solo un sitio para comprar naranjas; es una obra maestra del modernismo. Mira hacia arriba: esa cúpula de 30 metros decorada con naranjas y cerámicas es el corazón del edificio. Se inauguró en 1928 y cuenta la leyenda que la cotorra que corona el edificio se pasa el día chismorreando con la del mercado vecino.",
                text: `<h3>La Catedral del Producto Fresco</h3><p>El <strong>Mercado Central de Valencia</strong> es uno de los mercados en funcionamiento más antiguos y grandes de Europa. Inaugurado en 1928, destaca por su gran cúpula central de 30 metros.</p><h3>La Leyenda de la Cotorra</h3><p>En lo más alto del mercado hay una veleta con forma de cotorra. La leyenda dice que se pasa el día comentando los chismes de la ciudad con la del mercado vecino.</p>`
            },
            'lonja': {
                audio: "Estás pisando un Patrimonio de la Humanidad. La Lonja de la Seda era el centro del poder económico en el Siglo de Oro valenciano. Lo más impresionante es la Sala de Contratación. Fíjate en sus columnas: parecen palmeras de piedra que suben hasta el techo estrellado.",
                text: `<h3>El Templo del Comercio</h3><p>La <strong>Lonja de la Seda</strong> fue declarada <strong>Patrimonio de la Humanidad</strong> en 1996. Su Sala de Contratación, con columnas helicoidales que imitan palmeras, es una obra maestra del gótico.</p>`
            },
            'catedral': {
                audio: "Aquí se mezclan todos los estilos: románico, gótico y barroco. Pero lo que hace única a la Catedral de Valencia es lo que guarda dentro: el Santo Cáliz. Sí, el Vaticano reconoce que esta copa de ágata podría ser la que usó Jesucristo en la Última Cena.",
                text: `<h3>Una Mezcla de Estilos</h3><p>La <strong>Catedral de Valencia</strong> se construyó sobre una antigua mezquita. Es famosa por albergar el <strong>Santo Cáliz</strong> (el Santo Grial) y por su torre campanario, el Miguelete.</p>`
            },
            'albufera': {
                audio: "Bienvenido al espejo del sol. La Albufera es un parque natural donde el agua dulce se encuentra con el mar. Aquí nació la paella, entre arrozales y barracas tradicionales.",
                text: `<h3>Naturaleza en estado puro</h3><p>El <strong>Parque Natural de la Albufera</strong> es una laguna costera de agua dulce. Rodeada de arrozales, fue aquí donde se inventó la paella valenciana original.</p>`
            }
        };

        let currentPlace = null;
        let speechSynth = window.speechSynthesis;
        const MODELS_TO_TRY = ["gemini-pro", "gemini-1.5-flash", "gemini-1.0-pro"];

        async function fetchWithFallback(promptText) {
            for (const model of MODELS_TO_TRY) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                    });
                    if (response.ok) {
                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text;
                    }
                } catch (e) { }
            }
            throw new Error("Fail");
        }

        function navigate(sectionId) {
            if(speechSynth.speaking) speechSynth.cancel();
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden-section'));
            document.getElementById(sectionId).classList.remove('hidden-section');
            window.scrollTo(0,0);
        }

        const gridContainer = document.getElementById('places-grid');
        placesData.forEach(place => {
            const card = document.createElement('div');
            card.className = "bg-white rounded-2xl shadow-md overflow-hidden card-hover cursor-pointer transition";
            card.onclick = () => openPlaceDetail(place);
            const safeTitle = encodeURIComponent(place.title).replace(/'/g, '%27');
            
            // COLOR INDIGO EN LOS TEXTOS PEQUEÑOS
            card.innerHTML = `
                <div class="h-48 overflow-hidden bg-slate-200">
                    <img src="${place.image}" alt="${place.title}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/600x400?text=${safeTitle}';">
                </div>
                <div class="p-4"><h3 class="font-bold text-lg text-slate-800">${place.title}</h3><p class="text-sm text-slate-500 mt-1">${place.desc}</p>
                <div class="mt-4 flex items-center text-indigo-500 text-sm font-semibold"><span>Explorar contenido</span> <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i></div></div>`;
            gridContainer.appendChild(card);
        });

        function openPlaceDetail(place) {
            currentPlace = place;
            document.getElementById('detail-title').innerText = place.title;
            const detailImg = document.getElementById('detail-image');
            detailImg.src = place.image;
            detailImg.onerror = function() { this.onerror = null; const safeTitle = encodeURIComponent(place.title).replace(/'/g, '%27'); this.src = `https://placehold.co/800x400?text=${safeTitle}`; };
            document.getElementById('media-display-area').classList.add('hidden');
            if(speechSynth.speaking) speechSynth.cancel();
            navigate('detail');
        }

        function showMedia(type) {
            const displayArea = document.getElementById('media-display-area');
            const titleEl = document.getElementById('media-title').querySelector('span');
            const contentEl = document.getElementById('media-content');
            const badge = document.getElementById('status-badge');
            if(type !== 'audio' && speechSynth.speaking) speechSynth.cancel();
            displayArea.classList.remove('hidden'); displayArea.classList.add('fade-in'); contentEl.innerHTML = ''; badge.classList.add('hidden');
            const safeTitle = currentPlace.title.replace(/'/g, "\\'");

            switch(type) {
                case 'audio':
                    titleEl.innerText = `Audioguía`;
                    contentEl.innerHTML = `
                        <div class="flex flex-col items-center justify-center p-4 text-center">
                            <p class="mb-4 text-slate-600">Escucha la narración sobre ${currentPlace.title}.</p>
                            <button onclick="startAudioGuide('${safeTitle}')" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full flex items-center gap-2 transition shadow-lg"><i data-lucide="play" class="w-5 h-5"></i> <span>Escuchar</span></button>
                            <div id="audio-loading" class="hidden mt-6 flex flex-col items-center"><div class="loader mb-2"></div> <span class="text-sm text-indigo-500">Cargando...</span></div>
                            <div id="audio-controls" class="hidden mt-6 w-full max-w-md bg-slate-100 p-4 rounded-xl border border-slate-200">
                                <div class="flex items-center justify-center gap-4 mb-3"><div class="audio-wave"><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div></div><span class="text-indigo-600 font-bold text-sm">REPRODUCIENDO</span></div>
                                <p id="audio-text-display" class="text-sm text-slate-600 italic leading-relaxed"></p>
                                <button onclick="window.speechSynthesis.cancel(); document.getElementById('audio-controls').classList.add('hidden');" class="mt-3 text-xs text-red-500 underline hover:text-red-700">Detener</button>
                            </div>
                        </div>`;
                    break;
                case 'text':
                    titleEl.innerText = `Guía Histórica`;
                    contentEl.innerHTML = `
                        <div class="flex flex-col items-center justify-center p-4">
                            <p class="mb-4 text-center text-slate-600">Historia y curiosidades sobre ${currentPlace.title}.</p>
                            <button onclick="generateTextGuide('${safeTitle}')" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full flex items-center gap-2 transition shadow-lg mb-6"><i data-lucide="sparkles" class="w-5 h-5"></i> <span>Leer Historia</span></button>
                            <div id="text-loading" class="hidden flex flex-col items-center mb-4"><div class="loader mb-2 border-purple-200" style="border-top-color: #9333ea;"></div><span class="text-sm text-purple-600">Escribiendo...</span></div>
                            <div id="text-result" class="text-left prose prose-slate max-w-none w-full bg-slate-50 p-6 rounded-xl hidden"></div>
                        </div>`;
                    break;
                case 'video': titleEl.innerText = "Vídeo"; contentEl.innerHTML = `<div class="aspect-video bg-black rounded-lg flex items-center justify-center text-white"><div class="text-center"><i data-lucide="play-circle" class="w-16 h-16 mx-auto opacity-80"></i><p class="mt-2">Reproducir vídeo</p></div></div>`; break;
                case 'gallery': titleEl.innerText = "Galería"; contentEl.innerHTML = `<div class="grid grid-cols-2 gap-2"><div class="h-32 bg-slate-200 rounded-lg overflow-hidden"><img src="${currentPlace.image}" class="w-full h-full object-cover"></div><div class="h-32 bg-slate-200 rounded-lg flex items-center justify-center text-slate-400">Foto 2</div></div>`; break;
            }
            lucide.createIcons();
        }

        function setBadge(text, colorClass = "text-gray-500 bg-gray-100") {
            const badge = document.getElementById('status-badge');
            badge.innerText = text;
            badge.className = `text-xs font-normal px-2 py-1 rounded-full ${colorClass}`;
            badge.classList.remove('hidden');
        }

        async function startAudioGuide(placeName) {
            const loading = document.getElementById('audio-loading');
            const controls = document.getElementById('audio-controls');
            const textDisplay = document.getElementById('audio-text-display');
            const btn = document.querySelector('#media-content button');

            if(speechSynth.speaking) speechSynth.cancel();
            loading.classList.remove('hidden'); controls.classList.add('hidden'); if(btn) btn.classList.add('hidden');

            let textToRead = "";

            try {
                const prompt = `Escribe un párrafo audioguía muy breve sobre "${placeName}" en Valencia. 40 palabras. Tono amigable.`;
                textToRead = await fetchWithFallback(prompt);
                setBadge("Generado por IA", "text-indigo-600 bg-indigo-100");
            } catch (error) {
                console.log("Modo Offline activado");
                if (backupContent[currentPlace.id] && backupContent[currentPlace.id].audio) {
                    textToRead = backupContent[currentPlace.id].audio;
                    setBadge("Guía Verificada", "text-green-600 bg-green-100");
                } else { textToRead = "Información no disponible."; }
            }

            loading.classList.add('hidden');
            const utterance = new SpeechSynthesisUtterance(textToRead);
            utterance.lang = 'es-ES'; utterance.rate = 1.0;
            utterance.onstart = () => { controls.classList.remove('hidden'); textDisplay.innerText = `"${textToRead}"`; };
            utterance.onend = () => { controls.classList.add('hidden'); if(btn) btn.classList.remove('hidden'); };
            speechSynth.speak(utterance);
        }

        async function generateTextGuide(placeName) {
            const loading = document.getElementById('text-loading');
            const resultDiv = document.getElementById('text-result');
            const btn = document.querySelector('#media-content button'); 
            loading.classList.remove('hidden'); resultDiv.classList.add('hidden'); if(btn) btn.classList.add('hidden');

            try {
                const prompt = `Guía turística breve sobre "${placeName}" en Valencia. HTML simple con <h3> y <p>.`;
                const text = await fetchWithFallback(prompt);
                const cleanText = text.replace(/```html/g, '').replace(/```/g, '');
                resultDiv.innerHTML = cleanText; 
                setBadge("Generado por IA", "text-purple-600 bg-purple-100");
            } catch (error) { 
                console.log("Modo Offline activado");
                if (backupContent[currentPlace.id] && backupContent[currentPlace.id].text) {
                    resultDiv.innerHTML = backupContent[currentPlace.id].text;
                    setBadge("Guía Verificada", "text-green-600 bg-green-100");
                } else { resultDiv.innerHTML = "<p>Información no disponible.</p>"; }
            } finally { 
                loading.classList.add('hidden'); resultDiv.classList.remove('hidden'); 
            }
        }
    </script>
</body>
</html>
